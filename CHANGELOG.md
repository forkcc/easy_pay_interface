# 更新日志

## [1.2.0] - 2026-02-20

### 变更
- **数据库**：MySQL → PostgreSQL
  - 所有 Flyway 迁移脚本重写为 PostgreSQL 语法
  - `TINYINT` → `SMALLINT`、`DATETIME` → `TIMESTAMP`、`AUTO_INCREMENT` → `GENERATED BY DEFAULT AS IDENTITY`
  - 表注释改用 `COMMENT ON TABLE/COLUMN` 语句
  - 通过触发器函数 `update_updated_at()` 自动更新时间戳（替代 MySQL `ON UPDATE CURRENT_TIMESTAMP`）
  - `t_pay_order` 使用 PostgreSQL 声明式分区（`PARTITION BY RANGE`）
- **统计**：预聚合表 `t_order_stat_daily` 替换为 4 个 PostgreSQL 物化视图：
  - `mv_order_stat_daily` — 按日期+商户+代理+支付方式的每日统计
  - `mv_order_stat_mch` — 商户级汇总
  - `mv_order_stat_way` — 支付方式汇总
  - `mv_order_stat_platform_daily` — 平台每日总览
- `StatServiceImpl` 改用 `REFRESH MATERIALIZED VIEW CONCURRENTLY` + 原生查询（统计不再使用 JPA 实体/仓库）
- `DailyStatJob` 改为刷新全部 4 个物化视图，不再手动聚合
- Flyway 迁移脚本：V1~V11（原为 V1~V10），新增 V1 公共触发器函数、V9 物化视图
- POM 依赖：`mysql-connector-j` → `postgresql`、`flyway-mysql` → `flyway-database-postgresql`
- `application.yml`：JDBC 连接地址、驱动、Hibernate 方言切换为 PostgreSQL

### 移除
- `OrderStatDaily` 实体和 `OrderStatDailyRepository`（已由物化视图替代）
- `AccountConverter` 中 OrderStatDaily 相关方法
- 所有迁移脚本中的 MySQL 专用 DDL 语法

## [1.1.0] - 2026-02-21

### 新增
- **easy-pay-task** 模块：独立定时任务运行器（Dubbo 消费者）
  - `OrderExpireJob` — 关闭过期未支付订单（每 5 分钟）
  - `NotifyRetryJob` — 重试商户 HTTP 回调通知（每 1 分钟）
  - `DailyStatJob` — 聚合每日订单统计（每天 00:05）
  - `AutoSettleJob` — 处理待结算记录（每天 02:30）
- 通过 `TaskProperties` 支持各任务的 cron 表达式和批次大小配置
- 线程池调度器（4 线程），支持优雅停机
- `TASK_ENABLED` 环境变量作为定时任务全局开关

### 变更
- Flyway 迁移脚本从 2 个文件拆分为 10 个按业务域划分的文件（V1~V10）
- 所有 Flyway SQL 字段添加 COMMENT 注释
- README 更新，补充任务模块文档、Flyway 迁移表、项目目录树

## [1.0.0] - 2026-02-20

### 新增
- 初始项目结构，包含 easy-pay-api 和 easy-pay-provider 两个模块
- 6 大业务域：商户、支付、代理、账户/结算、统计、系统管理
- 15 个 Dubbo 服务接口及完整 CRUD 实现
- 25 张数据库表，支付订单表使用 MySQL 分区
- 每日聚合统计表（t_order_stat_daily）
- Flyway 数据库迁移（V1~V10，按业务域拆分）
- Dubbo Token 认证，控制服务访问权限
- Spring Data JPA + HikariCP 连接池优化
- Apache License 2.0 开源协议
